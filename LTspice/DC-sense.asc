Version 4
SHEET 1 4456 1252
WIRE 2592 -144 2400 -144
WIRE 2400 -128 2400 -144
WIRE 2400 -128 2288 -128
WIRE 2592 -128 2592 -144
WIRE 2288 -112 2288 -128
WIRE 1488 -96 1360 -96
WIRE 2400 -80 2400 -128
WIRE 3152 -80 2992 -80
WIRE 2992 -48 2992 -80
WIRE 1360 -32 1360 -96
WIRE 1392 -32 1360 -32
WIRE 2288 -32 2288 -48
WIRE 2288 -32 2224 -32
WIRE 2592 -32 2592 -48
WIRE 2704 -32 2592 -32
WIRE 1488 -16 1488 -96
WIRE 1488 -16 1456 -16
WIRE 1936 -16 1600 -16
WIRE 2000 -16 1936 -16
WIRE 2080 -16 2000 -16
WIRE 2288 -16 2288 -32
WIRE 2592 -16 2592 -32
WIRE 1184 0 848 0
WIRE 1392 0 1360 0
WIRE 1936 0 1936 -16
WIRE 2000 0 2000 -16
WIRE 2080 0 2080 -16
WIRE 1184 16 1184 0
WIRE 848 48 848 0
WIRE 2400 48 2400 0
WIRE 2400 48 2288 48
WIRE 2992 48 2992 32
WIRE 2288 64 2288 48
WIRE 2400 80 2400 48
WIRE 2592 80 2592 64
WIRE 2592 80 2400 80
WIRE 1184 112 1184 96
WIRE 1360 112 1184 112
WIRE 1600 112 1600 80
WIRE 1600 112 1360 112
WIRE 1872 112 1600 112
WIRE 1936 112 1936 64
WIRE 1936 112 1872 112
WIRE 2000 112 2000 80
WIRE 2000 112 1936 112
WIRE 2160 112 2000 112
WIRE 2208 112 2160 112
WIRE 2224 112 2224 -32
WIRE 2224 112 2208 112
WIRE 1184 128 1184 112
WIRE 1360 128 1360 112
WIRE 2208 128 2208 112
WIRE 2704 128 2704 -32
WIRE 2704 128 2208 128
WIRE 576 160 432 160
WIRE 848 160 848 128
WIRE 848 160 576 160
WIRE 3152 160 2992 160
WIRE 3312 160 3152 160
WIRE 3424 160 3392 160
WIRE 3504 160 3424 160
WIRE 432 192 432 160
WIRE 2992 192 2992 160
WIRE 3424 192 3424 160
WIRE 848 208 848 160
WIRE 2704 208 2208 208
WIRE 1184 224 1184 208
WIRE 1360 224 1360 192
WIRE 1360 224 1184 224
WIRE 1600 224 1360 224
WIRE 1872 224 1600 224
WIRE 1936 224 1872 224
WIRE 2000 224 1936 224
WIRE 2160 224 2000 224
WIRE 2208 224 2208 208
WIRE 2208 224 2160 224
WIRE 2224 224 2208 224
WIRE 1184 240 1184 224
WIRE 2592 240 2400 240
WIRE 1600 256 1600 224
WIRE 2400 256 2400 240
WIRE 2400 256 2288 256
WIRE 2592 256 2592 240
WIRE 1936 272 1936 224
WIRE 2000 272 2000 224
WIRE 2288 272 2288 256
WIRE 1472 288 1376 288
WIRE 2992 288 2992 272
WIRE 3424 288 3424 256
WIRE 432 304 432 272
WIRE 2400 304 2400 256
WIRE 848 336 848 288
WIRE 1184 336 1184 320
WIRE 1184 336 848 336
WIRE 1376 352 1376 288
WIRE 1392 352 1376 352
WIRE 2224 352 2224 224
WIRE 2288 352 2288 336
WIRE 2288 352 2224 352
WIRE 2592 352 2592 336
WIRE 2704 352 2704 208
WIRE 2704 352 2592 352
WIRE 1472 368 1472 288
WIRE 1472 368 1456 368
WIRE 1936 368 1936 336
WIRE 1936 368 1600 368
WIRE 2000 368 2000 352
WIRE 2000 368 1936 368
WIRE 2288 368 2288 352
WIRE 2592 368 2592 352
WIRE 1392 384 1360 384
WIRE 2000 384 2000 368
WIRE 2400 432 2400 384
WIRE 2400 432 2288 432
WIRE 2288 448 2288 432
WIRE 2400 464 2400 432
WIRE 2592 464 2592 448
WIRE 2592 464 2400 464
WIRE 1968 544 1952 544
WIRE 1952 560 1952 544
WIRE 2624 656 2512 656
WIRE 2512 672 2512 656
WIRE 2624 704 2624 656
WIRE 2512 752 2512 736
WIRE 2512 752 2448 752
WIRE 2512 768 2512 752
WIRE 2624 832 2624 784
WIRE 2624 832 2512 832
WIRE 2512 848 2512 832
WIRE 2448 896 2448 752
WIRE 2448 896 2432 896
WIRE 2432 912 2432 896
WIRE 2432 1008 2432 992
WIRE 2448 1008 2432 1008
WIRE 2624 1040 2512 1040
WIRE 2512 1056 2512 1040
WIRE 2624 1088 2624 1040
WIRE 2448 1136 2448 1008
WIRE 2512 1136 2512 1120
WIRE 2512 1136 2448 1136
WIRE 2512 1152 2512 1136
WIRE 2624 1216 2624 1168
WIRE 2624 1216 2512 1216
WIRE 2512 1232 2512 1216
FLAG 1952 560 0
FLAG 1968 544 MCU_GND
FLAG 432 304 0
FLAG 576 160 Vcm
FLAG 2160 112 ADC+
FLAG 2512 848 0
FLAG 2512 1232 0
FLAG 2160 224 ADC-
FLAG 1872 224 IN-
FLAG 2992 288 0
FLAG 3424 288 0
FLAG 3504 160 V_digital
FLAG 1872 112 IN+
FLAG 3152 160 Vdiff
FLAG 2992 48 0
FLAG 3152 -80 Vsum
FLAG 2288 64 0
FLAG 2288 448 0
FLAG 2624 656 3V3
FLAG 1424 -48 3V3
FLAG 1424 336 3V3
FLAG 1424 16 0
FLAG 1424 400 0
FLAG 2080 0 0
FLAG 2000 384 0
SYMBOL voltage 848 32 R0
WINDOW 123 29 92 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 39 45 Left 2
SYMATTR Value2 AC 1
SYMATTR Value {(1-balance)*Vdc}
SYMATTR InstName V1
SYMBOL res 1168 0 R0
SYMATTR InstName R5
SYMATTR Value 660k
SYMBOL res 1168 112 R0
SYMATTR InstName R6
SYMATTR Value 10k
SYMBOL res 1168 224 R0
SYMATTR InstName R7
SYMATTR Value 660k
SYMBOL cap 1920 0 R0
SYMATTR InstName C3
SYMATTR Value 6p
SYMBOL res 1984 -16 R0
SYMATTR InstName R8
SYMATTR Value 10Meg
SYMBOL voltage 432 176 R0
WINDOW 123 38 41 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 34 75 Left 2
SYMATTR Value2 AC 0
SYMATTR Value SINE(0 {Vac_amp/2} 50)
SYMATTR InstName V3
SYMBOL voltage 848 192 R0
WINDOW 123 29 92 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 39 45 Left 2
SYMATTR Value2 AC 1
SYMATTR Value {balance*Vdc}
SYMATTR InstName V2
SYMBOL diode 2528 736 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D1
SYMBOL diode 2528 832 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D2
SYMBOL voltage 2624 688 R0
WINDOW 123 29 92 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 39 45 Left 2
SYMATTR Value2 AC 0
SYMATTR Value 3.3
SYMATTR InstName V4
SYMBOL diode 2528 1120 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D3
SYMBOL diode 2528 1216 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D4
SYMBOL voltage 2624 1072 R0
WINDOW 123 29 92 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 39 45 Left 2
SYMATTR Value2 AC 0
SYMATTR Value 3.3
SYMATTR InstName V5
SYMBOL bv 2992 176 R0
SYMATTR InstName B1
SYMATTR Value V=V(ADC+)-V(ADC-)
SYMBOL res 3408 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 100k
SYMBOL cap 3408 192 R0
SYMATTR InstName C1
SYMATTR Value 100n
SYMBOL cap 1344 128 R0
SYMATTR InstName C2
SYMATTR Value 1µ
SYMBOL bv 2992 -64 R0
SYMATTR InstName B2
SYMATTR Value V=V(ADC+)+V(ADC-)
SYMBOL diode 2304 -48 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D5
SYMBOL diode 2304 48 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D6
SYMBOL voltage 2400 -96 R0
WINDOW 123 29 92 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 39 45 Left 2
SYMATTR Value2 AC 0
SYMATTR Value 3.3
SYMATTR InstName V6
SYMBOL diode 2304 336 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D7
SYMBOL diode 2304 432 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D8
SYMBOL voltage 2400 288 R0
WINDOW 123 29 92 Left 2
WINDOW 39 0 0 Left 0
WINDOW 3 39 45 Left 2
SYMATTR Value2 AC 0
SYMATTR Value 3.3
SYMATTR InstName V7
SYMBOL res 2576 240 R0
SYMATTR InstName R1
SYMATTR Value {Rbias}
SYMBOL res 2576 352 R0
SYMATTR InstName R12
SYMATTR Value {1.01*Rbias2}
SYMBOL res 2576 -144 R0
SYMATTR InstName R13
SYMATTR Value {Rbias}
SYMBOL res 2576 -32 R0
SYMATTR InstName R14
SYMATTR Value {Rbias2}
SYMBOL myspice\\LM358 1424 304 R0
SYMATTR InstName U1
SYMBOL myspice\\LM358 1424 -80 R0
SYMATTR InstName U2
SYMBOL cap 1920 272 R0
SYMATTR InstName C4
SYMATTR Value 6p
SYMBOL res 1984 256 R0
SYMATTR InstName R3
SYMATTR Value 10Meg
SYMBOL cap 1584 16 R0
SYMATTR InstName C5
SYMATTR Value 1µ
SYMBOL cap 1584 256 R0
SYMATTR InstName C6
SYMATTR Value 1µ
TEXT 936 -1224 Left 2 ;Battery Vdc measurement\nV4: 2x330k THT + 2x330k SMD\nC=4.7uF\n3,3V×((2×660+10)÷10) = 438.9V\n-> fg=3.4Hz\n \nV5: differential input\n2x330k THT + 2x330k SMD\nC=1.0uF\nVin,max,pos balanced, bias ignored\n3.3V×((2×660+5)÷5) = 874.5V\n-> fg=51Hz\n->STM32 allows Vcm = (Vref+ +Vref-)/2 = 1.66V only! -> Need two ADCs and software subtraction\n \nV6: differential input\n2x330k THT + 2x330k SMD\nC=1.0uF\nVin,max,pos balanced, bias ignored\n3.3V×((2×660+10)÷10) = 438.9V\n \nV7: differential input with unbalanced bias\n2x330k THT + 2x330k SMD\nC=1.0uF\nVin,max,pos balanced, bias ignored\n3.3V×((2×660+10)÷10) = 438.9V\n \n \n \n \n \n \n \n \n \nV8: differential input with opamp stage
TEXT 1712 -88 Left 2 ;STM32 Input\ninternal sample and hold capacitor has 4pF
TEXT -8 544 Left 2 ;possible problem: GND/PE coupling\n-> use Philipp Swoboda single ended to differential conversion with high impedance input. \nThis also uses full 2x3.3V differential range of STM32 ADC
TEXT -680 -728 Left 2 ;Human Body Model max 3mA\nVbat and Vdc measurement voltage divider max 1.5mA each.\nmax Voltage = 96*4.25V = 408V\nmin. R = 408V/1.5mA = 272kOhm
TEXT 328 -1224 Left 2 ;GaN FB Cell Vdc measurement\nV1:\nC=2.2nF\n3,3V×((2×470+7,5)÷7,5) = 416.9V\n-> fg=9.7kHz\n-> Groupdelay@100Hz = 16.4us\n \nV2: 2x220k THT + 2x180k SMD\nC=2.2nF\n3,3V×((2×400+6.2)÷6.2) = 429.1V\n-> fg=11.7kHz\n-> Groupdelay@100Hz = 13.6us
TEXT 632 -64 Left 2 !.param Vdc=400 Vac_amp=325 balance=0.5
TEXT 824 472 Left 2 ;.ac dec 2000 50 200k
TEXT 336 -848 Left 2 ;Battery Vdc measurement\nV3: 2x220k THT + 2x180k SMD\nC=3.3nF\n3,3V×((2×400+6.2)÷6.2) = 429.1V\n-> fg=7.8kHz\n-> Groupdelay@100Hz = 20.3us
TEXT 832 504 Left 2 ;.ac dec 2000 10 50k
TEXT 816 400 Left 2 !.tran 0 1 0 startup
TEXT 840 432 Left 2 ;.ac dec 2000 0.01 200
TEXT 160 96 Left 2 ;50 Hz with half of AC amplitude  with bipolar swichting
TEXT 1400 -1224 Left 2 ;IN- to GND impossible, because GND/PE drift causing measurement error.\nAt 313V ADC voltage is 1.7V -> balance ~0.63
TEXT 2448 616 Left 2 ;STM32 input protection
TEXT 2536 -216 Left 2 !.param Rbias=8200 Rbias2=4300
TEXT 1480 -1080 Left 2 ;Rbias=8200\n400V balance=0-1 -> V_digital=0.938V  balance=0 Vadc+=3.34V\n350V balance=0-1 -> V_digital=0.821V\n300V balance=0-1 -> V_digital=0.704V \n0,938V÷6.6V = 14%of 12bit ADC
TEXT 1488 -840 Left 2 ;Rbias=6800\n400V balance=0-1 -> V_digital=1.222V  balance=0 Vadc+=3.28V\n350V balance=0-1 -> V_digital=1.069V\n300V balance=0-1 -> V_digital=0.917V \n0,938V÷6.6V = 18.5%of 12bit ADC
TEXT 2224 -168 Left 2 ;STM32 input protection
TEXT 2568 -168 Left 2 ;positive bias
TEXT 1480 -656 Left 2 ;Rbias=10k Rbias2=3300 -> 0.819V\n400V balance=0-1 -> V_digital=1.002V  balance=0 Vadc+=2.07V Vsum=3.13V  balance=1 Vadc-=-0.434V   50Hz sine V-=-289mV Vcm=3.84V\n350V balance=0-1 -> V_digital=0.877V\n300V balance=0-1 -> V_digital=0.751V\n 1.002V÷6.6V = 15.2%of 12bit ADC
TEXT 1528 136 Left 2 ;extra 1uF\nnot necessary with diff input\nbut maybe for neg voltage filtering
TEXT 1480 -496 Left 2 ;Rbias=8k2 Rbias2=4300 -> 1.135V\n400V balance=0-1 -> balance=0 V_digital=1.090V  Vadc+=2.52V Vsum=3.96V    balance=1 V_digital=1.010V Vadc-=-0.265V    50Hz sine V-=-101mV Vcm=3.63V -> choose this and use 1uF filter if common mode causes problems\n350V balance=0-1 -> V_digital=0.954V\n300V balance=0-1 -> V_digital=0.817V\n 1.090V÷6.6V = 16.5%of 12bit ADC
TEXT 1480 -344 Left 2 ;Rbias=10k Rbias2=3600 -> 0.874V\n400V balance=0-1 -> balance=0 V_digital=1.046V  Vadc+=2.19V Vsum=3.337V    balance=1 V_digital=1.045V Vadc-=-0.451V   50Hz sine V-=-297mV Vcm=3.03V
TEXT 2808 432 Left 2 ;1% difference does not cause problems
